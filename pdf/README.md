# PDF Bookmarking
Why? To make navigating pdf textbooks as easy as real ones.

## Summary
- `filenames.py`: A tiny python module for filename handling. It will import if on `PYTHONPATH`.
- `interleaving.py`: A python script for interleaving/alternating lines matching certain TOC patterns. It will run if on `PATH`.
- `bkmk.py`: A python script for converting a TOC into a bookmarks file for one of several command-line utilities. It will run if on `PATH`.
- `sample.pdf`: A free pdf section of a textbook by [Michael Cross and Henry Greenside](https://webhome.phy.duke.edu/~hsg/pattern-formation-book/index.html).
- `sample.txt`: The raw TOC from `sample.pdf` as generated by `pdftotext` from the `poppler-utils` library.
- `sample1.txt`: Minimally edited `sample.txt` to remove blank lines and non-TOC entries.
- `sample2.txt`: The output of `interleaving.py` on `sample1.txt`.
- `sample3.txt`: The output of `bkmk.py create cpdf` on `sample2.txt`. Ready for `cpdf -add-bookmarks [bkmk file] [pdf input file] -o [pdf output file]`.
- `sample4.txt`: The output of `bkmk.py convert gs` on `sample3.txt`.
- `sample5.txt`: The output of `bkmk.py convert pdftk` on `sample4.txt`.

Though the code is documented with docstrings, this README is the main documentation.

## Depends

The outputs of this program would be useless without a pdf editing utility that takes the bookmarks this produces and incorporates them into a pdf document.
The author recommends `cpdf` and tries to support `Ghostscript` and `PDFtk` (more details below).
In addition, in order to not have to type many bookmark entries yourself, the author recommends the `pdftotext` tool in [`poppler-utils`](https://poppler.freedesktop.org/) to do some of the hard work.
Writing this code also depended on an effort of several days.
I hope that the code is easy to read, use, and is as stable as a rock.
And feel free to let me know what you think about it -- useful or not.

## Supports

This program definitively supports the cpdf format and makes an attempt to support Ghostscript/pdfmark and PDFtk.
However, the outputs of this program have not been tested on Ghostscript or PDFtk because I haven't installed them.
If you should run into format issues, have a go at fixing their defining regular expressions in the `BKMK_SYNTAX` dictionary in `bkmk.py`.

Where to obtain any of the pdf utilities:
- [`cpdf`](https://github.com/coherentgraphics/cpdf-binaries) has binaries available on Github and documentation [here](https://www.coherentpdf.com/cpdfmanual/cpdfmanual.html). I use this utility because of it is easy to learn, convenient to use, and well-documented.
- [`Ghostscript`](https://www.ghostscript.com/), which uses [pdfmark](https://www.adobe.com/content/dam/acom/en/devnet/acrobat/pdfs/pdfmarkreference.pdf), a pdf markup language, is capable of very high quality pdf work and tries to conform closely to Adobe's pdf standards.
- [`PDFtk`](https://www.pdflabs.com/tools/pdftk-server/) has a command line version which can be built from source on the preceeding link. It may also be available (and more or less guaranteed to work, unlike trying to build from source) from your package manager. For instance, in Debian this utility is available as the `pdftk-java` package.

Note these libraries are capable of many more things than bookmarks. 
I only have a need for quickly converting tables of contents to pdf bookmarks but have a look at those libraries to get an idea of what they can do because they might be useful to you.
It must also be said that these scripts aren't useful beyond generating bookmarks -- the maker of the pdf is left to do those operations themselves with any of the preceeding utilities. 
Also, these utilities are all free software for personal uses, just not commerical ones.

## Long Description

When creating bookmarks for a pdf text book, it is nice not to have to type everything yourself.
Hopefully this manual outlines the process effectively.

The most manual and straightforward option is to simply type up the TOC yourself.
Using the [`cpdf`](https://github.com/coherentgraphics/cpdf-binaries) utility the bookmark file outline is quite straight forwards.
The syntax for each line is
```
[index] "[text]" [page number]
```
Where each line represents a bookmark entry.

The `[index]` should be an integer representing the level of the bookmark entry in the index.
This numbering starts at 0, so a line with index 0 will appear at the top level of the bookmark.
If a line following 0 starts with a 1, that line will appear as a subentry to the 0
And a line starting with a 2 and following a 1 will appear as a subentry to the 1.
This can of course be repeated. 
It is common to group all entries in the same level of a TOC with the same index.
For example, all the beginnings of chapters may have index 0, their sections index 1, subsections index 2.
If the index goes beyond 2 you are probably dealing with a very large and detailed document!
It is best to reproduce the original structure of the TOC though, so if index larger than 2 is required then use it.

The `"[text]"` entry contains the text describing the bookmark entry.
It is often the title of the chapter or the name of the section.
Quotations surrounding the text are required.

The `[page number]` is the page number in the pdf at which the entry appears.
This is typically offset by a certain integer from the page numbers appearing in the TOC.
Because the Title page, TOC, and preface are usually numbered in roman numerals, this is why.
The first page of the pdf you see when it opens is page 1, and then the numbers go up from there.
The page number of the page corresponding to page 1 in the TOC indicates the offset that needs to be applied to all entries in the TOC.
For example, if page 1 in the TOC is page 15 in the pdf, then 14 must be added to each page number from the TOC.
It is often most convenient to automate this step.

The automation of pdf bookmark generation from a TOC seems like it would have utilities available for it.
You may fall into a variety of cases:
- The document was scanned, but without text identification, so the pdf is just a series of images
- The document was scanned with text identification
- The document was generated as a pdf (such as with LaTeX) and this is the best case scenario

In the first case you have no option but to type the table of contents yourself because one cannot retrieve its text with computer tools.
Presumably, if you had a software that could identify the characters and words in those images as text and associate those with the pdf, then you are in the second case.

If the document was scanned with text identification, you can copy and paste the text into a file you will process.
Libraries such as `poppler-utils` have tools such as `pdftotext` which could get the text for you.
However, the logical structure of the TOC is often lost in the output of that program.
For instance it may read the TOC by columns instead of by rows and you would have to program with that structure in mind.

If the document was generated as a pdf you can always copy and paste but you may have better luck using `pdftotext`, but the same applies.

The next stage is to prepare that text for a script that will rewrite it into the syntax described above.
One should run spellcheck on the copied text because text identification software often makes mistakes even if the quality of the scanned pdf is good.
Often, in the case of Mathematical textbooks there will be misread mathematical symbols (e.g. Infinity appears as "00") that you can fix.
Then one should consolidate the text of each TOC line onto a single line (often newlines appear because there are linebreaks in the pdf).
Then move the page numbers to the line following the corresponding entry.
So now a script can read in the TOC in pairs of lines: one with the text and another with the page number (and the index will be inferred by the script).

Now we can run that file through bkmk.py and use the output.
Some elements of the output will have to be reviewed by hand (such as entries with roman numerals) and some entries will have to be added by hand (such as the cover or preface) that weren't in the original TOC to begin with.
Then we can run `cpdf -add-bookmarks bkmk_file.txt document.pdf -o document_bkmkd.pdf` and use that pdf.
